import json
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, CallbackContext
from chatterbot import ChatBot
from chatterbot.trainers import ListTrainer

# Ø§ÛŒØ¬Ø§Ø¯ Ú†Øªâ€ŒØ¨Ø§Øª
chatbot = ChatBot("MyBot")
trainer = ListTrainer(chatbot)

# Ø¢Ù…ÙˆØ²Ø´ Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø§ Ú†Ù†Ø¯ Ø¬Ù…Ù„Ù‡ ÙØ§Ø±Ø³ÛŒ
trainer.train([
    "Ø³Ù„Ø§Ù…",
    "Ø³Ù„Ø§Ù…! Ú†Ø·ÙˆØ± Ù…ÛŒâ€ŒØªÙˆÙ†Ù… Ú©Ù…Ú©Øª Ú©Ù†Ù…ØŸ",
    "Ø§Ø³Ù… ØªÙˆ Ú†ÛŒÙ‡ØŸ",
    "Ù…Ù† ÛŒÚ© Ø±Ø¨Ø§Øª Ù‡ÙˆØ´Ù…Ù†Ø¯ ØªÙ„Ú¯Ø±Ø§Ù… Ù‡Ø³ØªÙ…!",
    "Ú†Ù‡ Ø®Ø¨Ø±ØŸ",
    "Ù‡Ù…Ù‡ Ú†ÛŒØ² Ø®ÙˆØ¨Ù‡! Ø´Ù…Ø§ Ú†Ø·ÙˆØ±ÛŒØ¯ØŸ"
])

# ØªÙˆÚ©Ù† Ø±Ø¨Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù…
TELEGRAM_BOT_TOKEN = "6012990205:AAGOpWHkY1tvEeAN8-bBZnCKimZ7KJH0I_8"

# ÙØ§ÛŒÙ„ Ø°Ø®ÛŒØ±Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
USER_DATA_FILE = "users.json"

# Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø§Ø² ÙØ§ÛŒÙ„
def load_users():
    try:
        with open(USER_DATA_FILE, "r", encoding="utf-8") as file:
            return json.load(file)
    except FileNotFoundError:
        return {}

# Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¯Ø± ÙØ§ÛŒÙ„
def save_users(users):
    with open(USER_DATA_FILE, "w", encoding="utf-8") as file:
        json.dump(users, file, indent=4, ensure_ascii=False)

# Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
users = load_users()

# Ø¯Ø³ØªÙˆØ± Ø§Ø³ØªØ§Ø±Øª
async def start(update: Update, context: CallbackContext):
    user_id = str(update.message.from_user.id)
    first_name = update.message.from_user.first_name

    if user_id not in users:
        users[user_id] = {"name": first_name, "messages": []}
        save_users(users)
        await update.message.reply_text(f"Ø³Ù„Ø§Ù… {first_name}! Ø§Ø² Ø§ÛŒÙ† Ø¨Ù‡ Ø¨Ø¹Ø¯ ØªÙˆ Ø±Ùˆ Ù…ÛŒâ€ŒØ´Ù†Ø§Ø³Ù…. ğŸ˜Š")
    else:
        await update.message.reply_text(f"Ø®ÙˆØ´ Ø¨Ø±Ú¯Ø´ØªÛŒ {users[user_id]['name']}! Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ø²Ù… Ø³ÙˆØ§Ù„ Ø¨Ù¾Ø±Ø³. ğŸ˜ƒ")

# Ù¾Ø§Ø³Ø® Ø¨Ù‡ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
async def chat(update: Update, context: CallbackContext):
    user_id = str(update.message.from_user.id)
    user_message = update.message.text

    # Ø°Ø®ÛŒØ±Ù‡ Ù¾ÛŒØ§Ù… Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ú©Ø§Ø±Ø¨Ø±
    if user_id in users:
        users[user_id]["messages"].append(user_message)
        save_users(users)

    bot_reply = chatbot.get_response(user_message)
    await update.message.reply_text(str(bot_reply))

# ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ
def main():
    app = Application.builder().token(TELEGRAM_BOT_TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, chat))

    print("âœ… Bot is running...")
    app.run_polling()

if __name__ == "__main__":
    main()
